---
title: "Recover LBA Parameters Using Parallel PDA"
output:
  html_document: default
  html_notebook: default
---

The first example replicates Turner and Sederberg's (2014) simulation study on 
page 234. We simulated 500 responses from the LBA model with their parameter 
values and then fit this data set with our parallel PDA algorithm.  For 
each proposal, we simulated the model 16384 times (2^14). This example shows 
that our parallel PDA is able to replicate Turner and Sederberg's (2014) 
finding. 


```{r Example1, eval=FALSE, include=TRUE}
rm(list=ls())
setwd("~/DMC_10052017")
source ("dmc/dmc.R")
source ("dmc/dmc_myfunction.R")
source ("dmc/models/LBA-gpda/dists.R")
source ("dmc/models/LBA-gpda/lba_B-gpda.R")

mod0 <- model.dmc(p.map = list(A  = "1", B   = "1", mean_v = "M", sd_v = "1",
                               t0 = "1", st0 = "1"),
                  constants = c(st0  = 0, sd_v = 1),
                  match.map = list(M = list(s1 = 1, s2 = 2)),
                  factors   = list(S = c("s1", "s2")),
                  responses = c("r1", "r2"),
                  type      = "norm")

## b = A + B
pvec <- c(A = .75, B = .25, mean_v.true = 2.5, mean_v.false = 1.5, t0 = .2)
mdi0 <- data.model.dmc( simulate.dmc(pvec, mod0, n = 5e2), mod0 )
p.prior <- prior.p.dmc(dists = c("tnorm", "tnorm", "tnorm", "tnorm", "beta"),
                       p1    = c(A = .3, B = .3, mean_v.true = 1,
                                 mean_v.false = 0, t0 = 1),
                       p2    = c(1, 1, 3, 3, 1),
                       lower = c(0, 0, NA, NA, .1),
                       upper = c(NA, NA, NA, NA, 1))
view(p.prior)
##              mean sd lower upper log    dist  untrans
## A             0.3  1     0   Inf   1   tnorm identity
## B             0.3  1     0   Inf   1   tnorm identity
## mean_v.true     1  3  -Inf   Inf   1   tnorm identity
## mean_v.false    0  3  -Inf   Inf   1   tnorm identity
## t0              1  1   0.1     1   1 beta_lu identity
samples <- samples.dmc(nmc = 400, p.prior, mdi0)  

## Each 500 steps take about 1.6 mins
##    user   system  elapsed 
##  41.092   55.000   96.282 
system.time(samples0 <- run.dmc(samples, report = 50, cores = 1, force = 4,
                                p.migrate = .05))
system.time(samples1 <- run.dmc(samples.dmc(nmc = 500, samples = samples0),
                                cores = 1, report = 100, force = 4))
system.time(samples2 <- run.dmc(samples.dmc(nmc = 500, samples = samples1),
                                cores = 1, report = 100, force = 4))
system.time(samples3 <- run.dmc(samples.dmc(nmc = 500, samples = samples2),
                                cores = 1, report = 100, force = 4))
system.time(samples4 <- run.dmc(samples.dmc(nmc = 500, samples = samples3),
                                cores = 1, report = 100, force = 4))
system.time(samples5 <- run.dmc(samples.dmc(nmc = 500, samples = samples4),
                                cores = 1, report = 100, force = 4))

check.recovery.dmc(samples5, pvec)
##                    A     B mean_v.true mean_v.false    t0
## True            0.75  0.25        2.50         1.50  0.20
## 2.5% Estimate   0.03  0.04        0.88        -0.35  0.11
## 50% Estimate    0.48  0.24        1.88         0.88  0.19
## 97.5% Estimate  0.97  0.63        2.74         1.70  0.25
## Median-True    -0.27 -0.01       -0.62        -0.62 -0.01

save(samples, samples0, samples1, samples2, samples3, samples4, samples5,
     mod0, pvec, p.prior, file="tutorial/LBA/Turner2014-example1.rda")

##                    A    B mean_v.true mean_v.false    t0
## True            0.75 0.25        2.50         1.50  0.20
## 2.5% Estimate   0.05 0.10        1.50         0.43  0.10
## 50% Estimate    0.53 0.25        2.02         1.09  0.19
## 97.5% Estimate  0.80 0.69        2.49         1.64  0.23
## Median-True    -0.22 0.00       -0.48        -0.41 -0.01
```

The second example shows a case that fails to recover parameters, using 
an identical PDA set-up (i.e., simulating 16384 samples for SPDF). This problem
can be easily fixed by increasing the number of simulated models to, for 
example, over 1,000,000[^1]. The critical difference between the two examples is
that the second example attempts to recover smaller drift rate (1 and 0.25 vs. 
2.5 and 1.5 in the first example).  However, the reason we can easily achieve 
this is that the computational time of parallel PDA is affected only slightly 
by an increase in the number of model simulations. 

[^1]: To be exact, we simulated 2^20 models. 

```{r Example2, eval=FALSE, include=TRUE}
mod0 <- model.dmc(p.map = list(A = "1", B = "1", mean_v = "M", sd_v = "1",
                                   t0 = "1", st0 = "1"),
                  constants = c(st0 = 0, sd_v = 1),
                  match.map = list(M = list(s1 = 1, s2 = 2)),
                  factors   = list(S = c("s1", "s2")),
                  responses = c("r1", "r2"),
                  type      = "norm")

pvec <- c(A = .25, B = .35, mean_v.true = 1, mean_v.false = .25, t0 = .2)
mdi0 <- data.model.dmc( simulate.dmc(pvec, mod0, n = 5e2), mod0 )

system.time(samples0 <- run.dmc(samples, report = 50, cores = 1, force = 4,
                                p.migrate = .05))
system.time(samples1 <- run.dmc(samples.dmc(nmc = 500, samples = samples0),
                                cores = 1, report = 100, force = 4))

check.recovery.dmc(samples1, pvec)
##                   A     B mean_v.true mean_v.false   t0
## True           0.25  0.35        1.00         0.25 0.20
## 2.5% Estimate  0.01  0.13        0.53        -0.60 0.15
## 50% Estimate   0.26  0.34        1.06         0.19 0.21
## 97.5% Estimate 0.51  0.62        1.45         0.74 0.27
## Median-True    0.01 -0.01        0.06        -0.06 0.01

save(samples, samples0, samples1, 
     mod0, pvec, p.prior, file="tutorial/LBA/Turner2014-example2.rda")

```


